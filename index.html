<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tip anyone on X with USDC ‚ö° (Arc testnet)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ethers.js v5 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- Load Lucide Icons -->
    <script type="module">
        import lucide from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        lucide.createIcons();
    </script>
    <style>
        /* Custom styles for aesthetic background and confetti effect */
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle radial gradient for depth and "pizzazz" */
            background: radial-gradient(at top left, #fefce8, #f0f9ff, #f7f9fa);
            min-height: 100vh;
        }
        .card {
            /* Soft, modern shadow */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: none; /* Remove border since we have a shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 6px 10px -3px rgba(0, 0, 0, 0.08);
        }
        /* Confetti container hidden by default */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-lg"> <!-- Increased max-width slightly for desktop feel -->
        
        <!-- HEADER TEXT -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
                Tip anyone on X with USDC ‚ö°
            </h1>
            <p class="mt-2 text-lg text-gray-600">
                Instantly powered by Arc Testnet. Gas and USDC sponsored by the contract.
            </p>
        </header>

        <!-- Main Content Grid for Tipping and Claiming -->
        <div class="grid grid-cols-1 gap-8">
            
            <!-- TIPPING CARD -->
            <div class="card bg-white p-8 rounded-2xl space-y-6">
                <h2 class="text-2xl font-bold text-teal-700 flex items-center mb-4">
                    <i data-lucide="send-horizontal" class="w-6 h-6 mr-3"></i>
                    Send a Tip
                </h2>

                <!-- Tipping Form -->
                <form id="tipForm" class="space-y-5">
                    <div>
                        <label for="twitterHandleTip" class="block text-sm font-semibold text-gray-700">Twitter/X Handle</label>
                        <div class="mt-1 relative rounded-xl">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <span class="text-gray-500 font-bold sm:text-md">@</span>
                            </div>
                            <input type="text" id="twitterHandleTip" placeholder="vitalik.eth" required
                                   class="focus:ring-teal-500 focus:border-teal-500 block w-full pl-8 pr-12 sm:text-md border-gray-300 rounded-xl p-3.5 transition duration-150">
                        </div>
                    </div>

                    <div>
                        <label for="amountTip" class="block text-sm font-semibold text-gray-700">Amount (USDC)</label>
                        <div class="mt-1 relative rounded-xl">
                            <input type="number" id="amountTip" value="1.00" step="any" min="0.01" required
                                   class="focus:ring-teal-500 focus:border-teal-500 block w-full pr-14 sm:text-md border-gray-300 rounded-xl p-3.5 transition duration-150">
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <span class="text-teal-600 font-medium sm:text-md">USDC</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="sendTipBtn"
                            class="w-full flex items-center justify-center p-4 border border-transparent rounded-xl text-lg font-bold text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-teal-500 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="send" class="w-6 h-6 mr-2"></i>
                        Send Tip Now
                    </button>
                </form>
            </div>

            <!-- Claim/Link CARD -->
            <div class="card bg-white p-8 rounded-2xl space-y-6">
                 <h2 class="text-2xl font-bold text-indigo-700 flex items-center mb-4">
                    <i data-lucide="award" class="w-6 h-6 mr-3"></i>
                    Recipient Portal
                </h2>
                <p class="text-sm text-gray-600">
                    Enter your handle below to check your pending balance or link your wallet for instant payments.
                </p>

                <div class="space-y-4">
                    <input type="text" id="twitterHandleClaim" placeholder="Your @handle to check" required
                           class="w-full p-3.5 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 sm:text-md transition duration-150">

                    <button id="connectWalletBtn"
                            class="w-full p-4 border border-transparent rounded-xl text-md font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out">
                        <i data-lucide="wallet" class="w-5 h-5 mr-2 inline-block"></i> Connect Wallet to Check Status
                    </button>

                    <div id="claimAction" class="hidden space-y-3 pt-3 border-t border-gray-100">
                        <p id="linkedWalletInfo" class="text-xs text-green-700 font-semibold pt-2"></p>
                        <p id="pendingTipsInfo" class="text-md text-gray-700 font-medium"></p>
                        
                        <button id="linkWalletBtn"
                                class="w-full p-3 border border-indigo-600 rounded-xl text-md font-semibold text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50">
                            Link Handle to Current Wallet
                        </button>
                        <button id="claimTipsBtn"
                                class="w-full p-3 border border-transparent rounded-xl text-md font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:opacity-50">
                            Claim Pending Tips
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Message Box -->
        <div id="statusMessage" class="hidden mt-8 p-4 rounded-xl text-sm transition duration-300 ease-in-out border" role="alert"></div>
    </div>

    <!-- Confetti Container -->
    <div id="confetti-container"></div>

    <script>
        // CRITICAL: Replace "YOUR_DEPLOYED_CONTRACT_ADDRESS" with the actual address
        // of your deployed PublicArcTipJar contract on the Arc Testnet.
        const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS";
        
        const USDC_ADDRESS = "0x1b3ce1d007e1b9d32793ba5df9f25d8a1f533d1c"; // Arc Testnet USDC
        const USDC_DECIMALS = 6;
        const CHAIN_ID = 13800001; // Arc Testnet Chain ID

        // The ABI is copied directly from the PublicArcTipJar.sol contract
        const CONTRACT_ABI = [
            // Constructor
            {
                "inputs": [
                    { "internalType": "address", "name": "_usdcAddress", "type": "address" },
                    { "internalType": "address", "name": "initialOwner", "type": "address" }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            // Errors (Ownable)
            { "inputs": [], "name": "OwnableInvalidOwner", "type": "error" },
            { "inputs": [ { "internalType": "address", "name": "account", "type": "address" } ], "name": "OwnableUnauthorizedAccount", "type": "error" },
            // Events
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "string", "name": "twitterHandle", "type": "string" },
                    { "indexed": true, "internalType": "address", "name": "claimant", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
                ],
                "name": "TipsClaimed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "string", "name": "twitterHandle", "type": "string" },
                    { "indexed": true, "internalType": "address", "name": "recipient", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" },
                    { "indexed": false, "internalType": "bool", "name": "claimedImmediately", "type": "bool" }
                ],
                "name": "TipSent",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "previousOwner", "type": "address" },
                    { "indexed": true, "internalType": "address", "name": "newOwner", "type": "address" }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "string", "name": "twitterHandle", "type": "string" },
                    { "indexed": true, "internalType": "address", "name": "wallet", "type": "address" }
                ],
                "name": "WalletLinked",
                "type": "event"
            },
            // Functions
            {
                "inputs": [ { "internalType": "string", "name": "twitterHandle", "type": "string" } ],
                "name": "claimTips",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "uint256", "name": "amount", "type": "uint256" } ],
                "name": "depositUSDC",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "string", "name": "twitterHandle", "type": "string" } ],
                "name": "linkedWallets",
                "outputs": [ { "internalType": "address", "name": "", "type": "address" } ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "string", "name": "twitterHandle", "type": "string" } ],
                "name": "pendingTips",
                "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [ { "internalType": "address", "name": "", "type": "address" } ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "string", "name": "twitterHandle", "type": "string" } ],
                "name": "linkWallet",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "string", "name": "twitterHandle", "type": "string" },
                    { "internalType": "uint256", "name": "amount", "type": "uint256" }
                ],
                "name": "tipTwitter",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "address", "name": "newOwner", "type": "address" } ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "usdc",
                "outputs": [ { "internalType": "contract IERC20", "name": "", "type": "address" } ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [ { "internalType": "uint256", "name": "amount", "type": "uint256" } ],
                "name": "withdrawUSDC",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let isConnected = false;

        const statusMessage = document.getElementById('statusMessage');
        const twitterHandleClaimInput = document.getElementById('twitterHandleClaim');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const claimActionDiv = document.getElementById('claimAction');
        const linkedWalletInfo = document.getElementById('linkedWalletInfo');
        const pendingTipsInfo = document.getElementById('pendingTipsInfo');
        const linkWalletBtn = document.getElementById('linkWalletBtn');
        const claimTipsBtn = document.getElementById('claimTipsBtn');
        const sendTipBtn = document.getElementById('sendTipBtn');

        /**
         * Utility function to display messages on the UI.
         */
        function showMessage(message, isError = false, txHash = null) {
            statusMessage.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700');
            statusMessage.innerHTML = message;

            if (isError) {
                statusMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            } else {
                statusMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            }

            if (txHash) {
                const explorerLink = `https://explorer.arc.io/tx/${txHash}`;
                const linkHtml = `<a href="${explorerLink}" target="_blank" class="font-semibold underline hover:text-green-900">View Transaction on Arc Explorer</a>`;
                statusMessage.innerHTML += `<div class="mt-2">${linkHtml}</div>`;
            }
        }

        /**
         * Initializes Ethers.js and connects the wallet.
         */
        async function initEthers() {
            try {
                if (!window.ethereum) {
                    throw new Error("MetaMask or a Web3 wallet is not detected.");
                }

                provider = new ethers.providers.Web3Provider(window.ethereum, "any");

                // Check chain ID
                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    showMessage(`Please switch your wallet to Arc Testnet (Chain ID: ${CHAIN_ID}) to continue.`, true);
                    return false;
                }

                // Request account connection
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Ensure CONTRACT_ADDRESS is not the placeholder before trying to interact
                if (CONTRACT_ADDRESS === "YOUR_DEPLOYED_CONTRACT_ADDRESS") {
                    showMessage("‚ö†Ô∏è Contract address is missing! Please deploy your Solidity contract and update the CONTRACT_ADDRESS variable.", true);
                    isConnected = false;
                    return false;
                }
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                isConnected = true;
                connectWalletBtn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2 inline-block"></i> Connected: ${userAddress.substring(0, 6)}...`;
                connectWalletBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                connectWalletBtn.classList.add('bg-gray-400', 'cursor-default');
                connectWalletBtn.disabled = true;

                showMessage(`Wallet connected successfully! Address: ${userAddress.substring(0, 6)}...`, false);
                // Re-initialize lucide icons for the button text
                lucide.createIcons();
                return true;

            } catch (error) {
                console.error("Connection error:", error);
                showMessage(`Error connecting wallet: ${error.message || error}`, true);
                isConnected = false;
                return false;
            }
        }

        /**
         * Clears and disables claim/link actions.
         */
        function resetClaimUI() {
            claimActionDiv.classList.add('hidden');
            linkedWalletInfo.textContent = '';
            pendingTipsInfo.textContent = '';
            linkWalletBtn.disabled = false; // Enable linking by default
            claimTipsBtn.disabled = true; // Disable claiming by default
        }

        /**
         * Updates the Claim Tips section based on handle information.
         */
        async function updateClaimInfo() {
            resetClaimUI();

            const handle = twitterHandleClaimInput.value.trim().toLowerCase();
            if (!handle) return;

            if (!isConnected) {
                showMessage("Please connect your wallet first to check claim status.", true);
                return;
            }
            
            // Re-check for missing contract address before making calls
            if (CONTRACT_ADDRESS === "YOUR_DEPLOYED_CONTRACT_ADDRESS") {
                showMessage("‚ö†Ô∏è Contract address is missing! Cannot fetch tip status.", true);
                return;
            }


            claimActionDiv.classList.remove('hidden');

            try {
                // 1. Check linked wallet
                const linkedAddress = await contract.linkedWallets(handle);
                const isLinked = linkedAddress !== ethers.constants.AddressZero;
                const isLinkedToCurrentUser = isLinked && (linkedAddress.toLowerCase() === userAddress.toLowerCase());

                // 2. Check pending tips
                const pendingAmountRaw = await contract.pendingTips(handle);
                const pendingAmount = ethers.utils.formatUnits(pendingAmountRaw, USDC_DECIMALS);

                // Update UI based on linked status
                if (isLinked) {
                    linkedWalletInfo.textContent = `Wallet Linked: ${linkedAddress.substring(0, 6)}...${linkedAddress.substring(38)}`;
                    linkWalletBtn.textContent = isLinkedToCurrentUser ? 'Already Linked to Your Wallet' : 'Overwrite Link (Be Careful)';
                    linkWalletBtn.disabled = isLinkedToCurrentUser;
                } else {
                    linkedWalletInfo.textContent = 'Status: Unlinked';
                    linkWalletBtn.textContent = 'Link Handle to Current Wallet';
                }

                // Update UI based on pending tips
                pendingTipsInfo.textContent = `Pending Balance: ${pendingAmount} USDC`;
                claimTipsBtn.disabled = !(isLinkedToCurrentUser && parseFloat(pendingAmount) > 0);
                claimTipsBtn.textContent = parseFloat(pendingAmount) > 0 ? `Claim ${pendingAmount} USDC` : 'No Tips to Claim';

            } catch (error) {
                console.error("Error fetching claim info:", error);
                showMessage(`Error fetching claim status: ${error.message || error}`, true);
            }
        }

        // --- Confetti Utility ---
        function runConfetti() {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.position = 'absolute';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * 100}vh`;
                confetti.style.opacity = Math.random() + 0.5;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.transition = 'all 2s ease-out';
                confetti.style.pointerEvents = 'none';

                container.appendChild(confetti);

                setTimeout(() => {
                    confetti.style.top = '100vh';
                    confetti.style.opacity = '0';
                    confetti.style.transform = `scale(0.1) translate(${Math.random() * 500 - 250}px, ${Math.random() * 500 - 250}px)`;
                }, 50);

                setTimeout(() => confetti.remove(), 2000);
            }
        }

        // --- Event Handlers ---

        document.getElementById('tipForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isConnected) {
                await initEthers();
                if (!isConnected) return;
            }
            
            // Re-check for missing contract address
            if (CONTRACT_ADDRESS === "YOUR_DEPLOYED_CONTRACT_ADDRESS") {
                showMessage("‚ö†Ô∏è Tip failed: Contract address is missing!", true);
                return;
            }

            const handle = document.getElementById('twitterHandleTip').value.trim();
            const amount = document.getElementById('amountTip').value;

            if (!handle || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                showMessage("Please enter a valid handle and a positive amount.", true);
                return;
            }

            sendTipBtn.disabled = true;
            sendTipBtn.innerHTML = '<i data-lucide="loader" class="w-6 h-6 mr-2 animate-spin"></i> Sending Tip...';
            // Re-initialize lucide icons for the button text
            lucide.createIcons();
            showMessage('Sending transaction to the Arc Testnet...', false);

            try {
                const amountWei = ethers.utils.parseUnits(amount, USDC_DECIMALS);
                // The owner must call tipTwitter, so we use the contract object signed by the current wallet.
                // Assuming the connected wallet is the contract owner for this function.
                const tx = await contract.tipTwitter(handle, amountWei);

                showMessage(`Transaction submitted! Waiting for confirmation...`, false, tx.hash);

                await tx.wait();

                showMessage(`üéâ Success! ${amount} USDC tipped to @${handle}!`, false, tx.hash);
                runConfetti();

            } catch (error) {
                console.error("Tip error:", error);
                // Attempt to extract a meaningful error message
                let errorMessage = "Transaction failed.";
                if (error.data && error.data.message) {
                    errorMessage = error.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                showMessage(`Tip failed: ${errorMessage}`, true);
            } finally {
                sendTipBtn.disabled = false;
                sendTipBtn.innerHTML = '<i data-lucide="send" class="w-6 h-6 mr-2"></i> Send Tip Now';
                // Re-initialize lucide icons for the button text
                lucide.createIcons();
            }
        });

        connectWalletBtn.addEventListener('click', initEthers);

        // Debounce for better UX, prevents excessive calls while typing
        let debounceTimer;
        twitterHandleClaimInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateClaimInfo, 500);
        });

        linkWalletBtn.addEventListener('click', async () => {
            if (!isConnected) {
                showMessage("Please connect your wallet first.", true);
                return;
            }
            if (CONTRACT_ADDRESS === "YOUR_DEPLOYED_CONTRACT_ADDRESS") {
                showMessage("‚ö†Ô∏è Link failed: Contract address is missing!", true);
                return;
            }
            
            const handle = twitterHandleClaimInput.value.trim();
            if (!handle) {
                showMessage("Please enter a handle to link.", true);
                return;
            }

            linkWalletBtn.disabled = true;
            linkWalletBtn.textContent = 'Linking...';

            try {
                const tx = await contract.linkWallet(handle);
                showMessage(`Link transaction submitted! Waiting for confirmation...`, false, tx.hash);
                await tx.wait();
                showMessage(`‚úÖ Success! @${handle} is now linked to your wallet.`, false, tx.hash);
                updateClaimInfo();
            } catch (error) {
                console.error("Link error:", error);
                showMessage(`Link failed: ${error.message || "Transaction failed."}`, true);
            } finally {
                linkWalletBtn.textContent = 'Link Handle to Current Wallet';
                linkWalletBtn.disabled = false;
            }
        });

        claimTipsBtn.addEventListener('click', async () => {
            if (!isConnected) {
                showMessage("Please connect your wallet first.", true);
                return;
            }
            if (CONTRACT_ADDRESS === "YOUR_DEPLOYED_CONTRACT_ADDRESS") {
                showMessage("‚ö†Ô∏è Claim failed: Contract address is missing!", true);
                return;
            }

            const handle = twitterHandleClaimInput.value.trim();
            if (!handle) {
                showMessage("Please enter a handle to claim tips.", true);
                return;
            }

            claimTipsBtn.disabled = true;
            claimTipsBtn.textContent = 'Claiming...';

            try {
                const tx = await contract.claimTips(handle);
                showMessage(`Claim transaction submitted! Waiting for confirmation...`, false, tx.hash);
                await tx.wait();
                showMessage(`üí∞ Claim Success! Your tips have been sent to your wallet.`, false, tx.hash);
                updateClaimInfo();
            } catch (error) {
                console.error("Claim error:", error);
                showMessage(`Claim failed: ${error.message || "Transaction failed. Check if you are the linked wallet and have pending tips."}`, true);
            } finally {
                claimTipsBtn.textContent = 'Claim Pending Tips';
                claimTipsBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
